// Internationalization Object
const i18n = {
    en: {
        // UI Elements
        siteTitle: "Solar Solutions",
        heroTitle: "Smart Solar Solutions for Your Home",
        heroSubtitle: "Automated, efficient and cost-effective solar systems with maximum ROI",
        featuresTitle: "Solar System Features",
        featuresSubtitle: "Discover the advanced features of our automated solar solutions",
        formTitle: "Get Your Solar Consultation",
        formSubtitle: "Fill in your details and we'll contact you within 24 hours",
        fullName: "Full Name",
        whatsappNumber: "WhatsApp Number",
        address: "Address",
        monthlyBill: "Monthly Average Electricity Bill (INR)",
        systemSize: "Interested System Size",
        selectOption: "Select an option",
        custom: "Custom",
        mapLink: "Google Maps Location Link (Optional)",
        mapHint: "Paste your Google Maps link for precise location",
        consentText: "I agree to be contacted via WhatsApp for solar consultation",
        submitBtn: "Submit & Chat on WhatsApp",
        formNote: "Your data is secure and will only be used for solar consultation",
        loading: "Processing your request...",
        successMessage: "Form submitted successfully! Opening WhatsApp...",
        errorMessage: "Please check all fields and try again",
        
        // Features (20 items)
        features: [
            "India's First Fully Automated Solar Cleaning System",
            "+5% More Power Generation Compared to Manual Cleaning",
            "6:00 AM Daily Automatic Self-Cleaning (Effortless, Zero Maintenance)",
            "High-pressure Sprinklers + CPVC Piping",
            "1 HP Water Pump (Steady Pressure)",
            "20%–30% Annual Return on Investment (ROI)",
            "Complete Payback in 3–3.5 Years",
            "Tier-1 Quality Components",
            "Global Standard Engineering",
            "Zero Hidden Charges",
            "Complete End-to-End Solution (Design + Materials + Installation)",
            "24×7 System Monitoring",
            "48-Hour Service Response",
            "Smart Energy Optimizer (Can Reduce Electricity Consumption by up to 20%)",
            "Real-time Solar Generation Monitoring (Mobile App Based)",
            "Free Comprehensive System Insurance",
            "Government Subsidy Available (₹78,000 as per MNRE – actual subsidy may vary)",
            "Detailed Project Report Before Installation",
            "Net Metering Application + Coordination Included",
            "Strong Warranties:\n• Panels: 12 years product + 30 years performance\n• Inverter: 10 years\n• Structure: 5 years"
        ]
    },
    
    hi: {
        siteTitle: "सोलर समाधान",
        heroTitle: "आपके घर के लिए स्मार्ट सोलर समाधान",
        heroSubtitle: "स्वचालित, कुशल और लागत प्रभावी सौर प्रणाली अधिकतम ROI के साथ",
        featuresTitle: "सोलर सिस्टम फीचर्स",
        featuresSubtitle: "हमारे स्वचालित सोलर समाधानों की उन्नत विशेषताओं की खोज करें",
        formTitle: "अपनी सोलर कंसल्टेशन प्राप्त करें",
        formSubtitle: "अपना विवरण भरें और हम 24 घंटे के भीतर संपर्क करेंगे",
        fullName: "पूरा नाम",
        whatsappNumber: "व्हाट्सएप नंबर",
        address: "पता",
        monthlyBill: "मासिक औसत बिजली बिल (INR)",
        systemSize: "इच्छित सिस्टम आकार",
        selectOption: "एक विकल्प चुनें",
        custom: "कस्टम",
        mapLink: "Google Maps लोकेशन लिंक (वैकल्पिक)",
        mapHint: "सटीक स्थान के लिए अपना Google Maps लिंक पेस्ट करें",
        consentText: "मैं सोलर कंसल्टेशन के लिए WhatsApp के माध्यम से संपर्क किए जाने से सहमत हूं",
        submitBtn: "सबमिट करें और WhatsApp पर चैट करें",
        formNote: "आपका डेटा सुरक्षित है और केवल सोलर कंसल्टेशन के लिए उपयोग किया जाएगा",
        loading: "आपका अनुरोध प्रोसेस हो रहा है...",
        successMessage: "फॉर्म सफलतापूर्वक सबमिट हो गया! WhatsApp खोला जा रहा है...",
        errorMessage: "कृपया सभी फ़ील्ड्स जांचें और पुनः प्रयास करें",
        
        features: [
            "भारत का पहला Fully Automated Solar Cleaning System",
            "+5% ज्यादा बिजली उत्पादन Manual Cleaning के मुकाबले",
            "6:00 AM रोज automatic self-cleaning (बिना मेहनत, Zero Maintenance)",
            "High-pressure sprinklers + CPVC पाइपिंग",
            "1 HP Water Pump (steady pressure)",
            "20%–30% Annual Return on Investment (ROI)",
            "3–3.5 साल में पूरा पैसा वसूल",
            "Tier-1 Quality Components",
            "Global standard engineering",
            "Zero hidden charges",
            "Complete end-to-end solution (design + materials + installation)",
            "24×7 system monitoring",
            "48-hour service response",
            "Smart Energy Optimizer (20% तक बिजली खपत कम कर सकता है)",
            "Real-time solar generation monitoring (Mobile App based)",
            "Free comprehensive system insurance",
            "सरकारी सब्सिडी उपलब्ध (₹78,000 as per MNRE – actual subsidy may vary)",
            "Detailed project report before installation",
            "Net metering application + coordination included",
            "Strong warranties:\n• Panels: 12 years product + 30 years performance\n• Inverter: 10 years\n• Structure: 5 years"
        ]
    },
    
    mr: {
        siteTitle: "सोलार सोल्युशन्स",
        heroTitle: "तुमच्या घरासाठी स्मार्ट सोलार सोल्युशन्स",
        heroSubtitle: "स्वयंचलित, कार्यक्षम आणि किफायतशीर सौर प्रणाली जास्तीत जास्त ROI सह",
        featuresTitle: "सोलार सिस्टम वैशिष्ट्ये",
        featuresSubtitle: "आमच्या स्वयंचलित सौर उपायांची प्रगत वैशिष्ट्ये शोधा",
        formTitle: "तुमची सोलार सल्ला मिळवा",
        formSubtitle: "तुमचा तपशील भरा आणि आम्ही 24 तासांत संपर्क साधू",
        fullName: "पूर्ण नाव",
        whatsappNumber: "व्हाट्सएप क्रमांक",
        address: "पत्ता",
        monthlyBill: "मासिक सरासरी वीज बिल (INR)",
        systemSize: "इच्छित सिस्टम आकार",
        selectOption: "एक पर्याय निवडा",
        custom: "सानुकूल",
        mapLink: "Google Maps स्थान दुवा (वैकल्पिक)",
        mapHint: "अचूक स्थानासाठी तुमचा Google Maps दुवा पेस्ट करा",
        consentText: "सौर सल्लामसलत करिता WhatsApp मार्फत संपर्क साधण्यास मी सहमत आहे",
        submitBtn: "सबमिट करा आणि WhatsApp वर चॅट करा",
        formNote: "तुमचा डेटा सुरक्षित आहे आणि फक्त सोलार सल्लामसलत करिता वापरला जाईल",
        loading: "तुमची विनंती प्रक्रिया करत आहे...",
        successMessage: "फॉर्म यशस्वीरित्या सबमिट झाला! WhatsApp उघडले जात आहे...",
        errorMessage: "कृपया सर्व फील्ड तपासा आणि पुन्हा प्रयत्न करा",
        
        features: [
            "भारतातील पहिले पूर्णपणे स्वयंचलित सौर स्वच्छता प्रणाली",
            "हस्तचालित स्वच्छतेपेक्षा +5% जास्त वीज निर्मिती",
            "दररोज सकाळी 6:00 वाजता स्वयंचलित स्वच्छता (श्रम नाही, शून्य देखभाल)",
            "उच्च-दाब शिंपणी प्रणाली + CPVC पाईपिंग",
            "1 एचपी पाणी पंप (स्थिर दाब)",
            "20%–30% वार्षिक गुंतवणुकीवर परतावा (ROI)",
            "3–3.5 वर्षांत पूर्ण गुंतवणूक परत",
            "टीयर-1 गुणवत्तेचे घटक",
            "जागतिक मानक अभियांत्रिकी",
            "शून्य लपलेले शुल्क",
            "संपूर्ण एंड-टू-एंड उपाय (डिझाइन + साहित्य + स्थापना)",
            "24×7 सिस्टम देखरेख",
            "48-तास सेवा प्रतिसाद",
            "स्मार्ट एनर्जी ऑप्टिमायझर (20% पर्यंत वीज वापर कमी करू शकते)",
            "रिअल-टाइम सौर निर्मिती देखरेख (मोबाइल अॅप आधारित)",
            "विनामूल्य व्यापक प्रणाली विमा",
            "सरकारी अनुदान उपलब्ध (₹78,000 MNRE प्रमाणे – वास्तविक अनुदान बदलू शकते)",
            "स्थापनेपूर्वी तपशीलवार प्रकल्प अहवाल",
            "नेट मीटरिंग अर्ज + समन्वय समाविष्ट",
            "मजबूत हमी:\n• पॅनेल्स: 12 वर्षे उत्पादन + 30 वर्षे कार्यक्षमता\n• इन्व्हर्टर: 10 वर्षे\n• संरचना: 5 वर्षे"
        ]
    }
};

// Current Language
let currentLang = 'en';
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby98cpaDxsrCq7_dYFBoXWxEUhX3Mo9jk3tZg8PHQffbKYCDpbhLG3XWgwbmmAfNnAy/exec'; // Replace with your Google Script URL

// DOM Elements
const langButtons = document.querySelectorAll('.lang-btn');
const featuresAccordion = document.getElementById('featuresAccordion');
const leadForm = document.getElementById('leadForm');
const toast = document.getElementById('toast');
const loadingOverlay = document.getElementById('loadingOverlay');
const mapLinkInput = document.getElementById('mapLink');
const mapPreview = document.getElementById('mapPreview');

// Icons for features
const featureIcons = [
    'fas fa-robot',
    'fas fa-bolt',
    'fas fa-clock',
    'fas fa-shower',
    'fas fa-water',
    'fas fa-chart-line',
    'fas fa-rupee-sign',
    'fas fa-award',
    'fas fa-globe',
    'fas fa-eye-slash',
    'fas fa-cogs',
    'fas fa-desktop',
    'fas fa-headset',
    'fas fa-leaf',
    'fas fa-mobile-alt',
    'fas fa-shield-alt',
    'fas fa-hand-holding-usd',
    'fas fa-file-alt',
    'fas fa-plug',
    'fas fa-clipboard-check'
];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initLanguageSwitcher();
    initFeaturesAccordion();
    initFormValidation();
    initMapPreview();
    setLanguage(currentLang);
});

// Language Switcher
function initLanguageSwitcher() {
    langButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const lang = this.getAttribute('data-lang');
            langButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            setLanguage(lang);
        });
    });
}

// Set Language
function setLanguage(lang) {
    currentLang = lang;
    const translations = i18n[lang];
    
    // Update all elements with data-i18n attribute
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[key]) {
            if (element.tagName === 'INPUT' && element.type === 'placeholder') {
                element.placeholder = translations[key];
            } else if (element.tagName === 'OPTION') {
                element.textContent = translations[key];
            } else {
                element.textContent = translations[key];
            }
        }
    });
    
    // Update features in accordion
    updateFeaturesContent(lang);
}

// Initialize Features Accordion
function initFeaturesAccordion() {
    const features = i18n.en.features;
    
    features.forEach((feature, index) => {
        const featureItem = document.createElement('div');
        featureItem.className = 'feature-item';
        featureItem.innerHTML = `
            <div class="feature-header">
                <h3 data-i18n-key="feature-${index}">${feature.split('\n')[0]}</h3>
                <div class="feature-icon">
                    <i class="${featureIcons[index]}"></i>
                </div>
                <div class="feature-toggle">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="feature-content">
                <p data-i18n-content="feature-${index}">${feature}</p>
            </div>
        `;
        
        featureItem.querySelector('.feature-header').addEventListener('click', function() {
            const isActive = featureItem.classList.contains('active');
            
            // Close all other items
            document.querySelectorAll('.feature-item.active').forEach(item => {
                if (item !== featureItem) {
                    item.classList.remove('active');
                }
            });
            
            // Toggle current item
            featureItem.classList.toggle('active', !isActive);
        });
        
        featuresAccordion.appendChild(featureItem);
    });
}

// Update Features Content
function updateFeaturesContent(lang) {
    const translations = i18n[lang];
    
    document.querySelectorAll('.feature-item').forEach((item, index) => {
        const title = item.querySelector('h3');
        const content = item.querySelector('.feature-content p');
        
        if (title && content && translations.features[index]) {
            const featureText = translations.features[index];
            title.textContent = featureText.split('\n')[0];
            content.textContent = featureText;
        }
    });
}

// Form Validation
function initFormValidation() {
    const whatsappInput = document.getElementById('whatsapp');
    const nameInput = document.getElementById('name');
    const addressInput = document.getElementById('address');
    const monthlyBillInput = document.getElementById('monthlyBill');
    
    // WhatsApp validation
    whatsappInput.addEventListener('input', function() {
        const value = this.value.replace(/\D/g, '');
        this.value = value;
        
        if (value.length === 10) {
            const isValid = /^[6-9]\d{9}$/.test(value);
            document.getElementById('whatsappError').textContent = isValid ? '' : 'Please enter a valid Indian mobile number';
        }
    });
    
    // Name validation
    nameInput.addEventListener('input', function() {
        const isValid = this.value.trim().length >= 2;
        document.getElementById('nameError').textContent = isValid ? '' : 'Name must be at least 2 characters';
    });
    
    // Address validation
    addressInput.addEventListener('input', function() {
        const isValid = this.value.trim().length >= 10;
        document.getElementById('addressError').textContent = isValid ? '' : 'Please enter a complete address';
    });
    
    // Monthly bill validation
    monthlyBillInput.addEventListener('input', function() {
        const value = parseInt(this.value);
        const isValid = !isNaN(value) && value >= 500;
        document.getElementById('billError').textContent = isValid ? '' : 'Minimum bill amount is ₹500';
    });
}

// Map Preview
function initMapPreview() {
    mapLinkInput.addEventListener('change', function() {
        const url = this.value.trim();
        if (!url) {
            mapPreview.style.display = 'none';
            return;
        }
        
        // Extract coordinates from Google Maps URL
        let embedUrl = '';
        
        if (url.includes('@')) {
            // URL with coordinates
            const match = url.match(/@([-\d.]+),([-\d.]+)/);
            if (match) {
                embedUrl = `https://maps.google.com/maps?q=${match[1]},${match[2]}&z=15&output=embed`;
            }
        } else if (url.includes('maps.google.com') || url.includes('goo.gl/maps')) {
            // Standard Google Maps URL
            embedUrl = url.replace('/maps/', '/maps/embed/v1/place?q=') + '&key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8';
        }
        
        if (embedUrl) {
            mapPreview.innerHTML = `<iframe src="${embedUrl}" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"></iframe>`;
            mapPreview.style.display = 'block';
        } else {
            mapPreview.style.display = 'none';
        }
    });
}

// Show Toast
function showToast(message, type = 'success') {
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 5000);
}

// Show Loading
function showLoading(show) {
    if (show) {
        loadingOverlay.classList.add('active');
    } else {
        loadingOverlay.classList.remove('active');
    }
}

// Generate WhatsApp Message
function generateWhatsAppMessage(formData) {
    const message = `New Solar Lead:

Name: ${formData.name}
WhatsApp: ${formData.whatsapp}
Address: ${formData.address}
Map: ${formData.map_link || 'Not provided'}
Monthly Avg Bill: ₹${formData.monthly_bill}
Interested System Size: ${formData.system_size} kW
Language: ${currentLang.toUpperCase()}

Please contact the user.`;
    
    return encodeURIComponent(message);
}

// Submit to Google Sheets
async function submitToGoogleSheets(formData) {
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
                ...formData,
                lang: currentLang,
                timestamp: new Date().toISOString()
            })
        });
        
        // Note: With no-cors mode, we can't read the response
        return true;
    } catch (error) {
        console.error('Google Sheets submission error:', error);
        return false;
    }
}

// Form Submission
leadForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Validate form
    const name = document.getElementById('name').value.trim();
    const whatsapp = document.getElementById('whatsapp').value.trim();
    const address = document.getElementById('address').value.trim();
    const monthlyBill = document.getElementById('monthlyBill').value.trim();
    const systemSize = document.getElementById('systemSize').value;
    const mapLink = document.getElementById('mapLink').value.trim();
    const consent = document.getElementById('consent').checked;
    
    // Basic validation
    if (!name || !whatsapp || !address || !monthlyBill || !systemSize || !consent) {
        showToast(i18n[currentLang].errorMessage, 'error');
        return;
    }
    
    if (!/^[6-9]\d{9}$/.test(whatsapp)) {
        showToast('Please enter a valid 10-digit Indian mobile number', 'error');
        return;
    }
    
    // Prepare form data
    const formData = {
        name,
        whatsapp: `+91${whatsapp}`,
        address,
        monthly_bill: monthlyBill,
        system_size: systemSize,
        map_link: mapLink
    };
    
    // Show loading
    showLoading(true);
    
    try {
        // Submit to Google Sheets in background
        submitToGoogleSheets(formData);
        
        // Generate WhatsApp URL
        const whatsappMessage = generateWhatsAppMessage(formData);
        const whatsappUrl = `https://wa.me/919766893279?text=${whatsappMessage}`;
        
        // Show success message
        showToast(i18n[currentLang].successMessage, 'success');
        
        // Open WhatsApp after a short delay
        setTimeout(() => {
            window.open(whatsappUrl, '_blank');
            showLoading(false);
            
            // Reset form
            leadForm.reset();
            mapPreview.style.display = 'none';
            
            // Close all accordion items
            document.querySelectorAll('.feature-item.active').forEach(item => {
                item.classList.remove('active');
            });
        }, 1500);
        
    } catch (error) {
        showLoading(false);
        showToast('An error occurred. Please try again.', 'error');
        console.error('Form submission error:', error);
    }
});